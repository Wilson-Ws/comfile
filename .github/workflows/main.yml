name: main

on:
  repository_dispatch:
  workflow_dispatch:

jobs:
  request-content:
    runs-on: ubuntu-latest  # 使用 Ubuntu 环境

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install necessary tools
        run: |
          # 安装 jq 和 html2text，用于处理 JSON 和 HTML 转文本
          sudo apt-get update
          sudo apt-get install -y jq python3-pip
          pip3 install python-dotenv html2text

      - name: Load variables from .env file
        run: |
          # 使用 dotenv 来加载 .env 文件中的变量
          python3 -c 'from dotenv import load_dotenv; load_dotenv()'

      - name: Fetch HTML content using curl
        run: |
          # 使用 curl 获取网页的 HTML 内容
          curl -H "User-Agent: Loon/917 CFNetwork/3826.600.41 Darwin/24.6.0" \
            "https://kelee.one/Tool/Loon/Lpx/${{ secrets.URL_PART }}.lpx" \
            -o "response.html"

      - name: Convert HTML to text
        run: |
          # 使用 html2text 将 HTML 内容转换为纯文本
          python3 -m html2text response.html > response.txt

      - name: Create target directory
        run: |
          # 确保目标目录存在
          mkdir -p Loon/LPX

      - name: Save text content to file
        run: |
          # 将转换后的文本内容保存到指定路径
          mv response.txt "Loon/LPX/${{ secrets.FILENAME }}"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Loon/LPX/${{ secrets.FILENAME }}
          git commit -m "Add text content from ${{ secrets.URL_PART }}.lpx"
          git push
