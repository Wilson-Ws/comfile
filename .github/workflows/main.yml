name: main

on:
  repository_dispatch:
  workflow_dispatch:

jobs:
  request-content:
    runs-on: ubuntu-latest  # 使用 Ubuntu 环境

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          # 安装必要的工具
          sudo apt-get update
          sudo apt-get install -y wget
          sudo apt-get install -y python3-pip
          pip3 install python-dotenv
          npm install puppeteer

      - name: Load variables from .env file
        run: |
          # 加载 .env 文件中的变量
          python3 -c 'from dotenv import load_dotenv; load_dotenv()'

      - name: Run Puppeteer script to fetch content
        run: |
          # 创建 puppeteer.js 脚本，执行 JavaScript 和处理 cookies
          echo "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          
          (async () => {
            const browser = await puppeteer.launch({ headless: true });
            const page = await browser.newPage();
            
            // 设置请求头（如有需要）
            await page.setUserAgent('Loon/917 CFNetwork/3826.600.41 Darwin/24.6.0');

            // 如果需要，设置 cookies
            await page.setCookie({ 
              name: 'my_cookie', 
              value: 'cookie_value', 
              domain: 'kelee.one' 
            });

            // 跳转到目标页面
            await page.goto('https://kelee.one/Tool/Loon/Lpx/${{ secrets.URL_PART }}.lpx', { waitUntil: 'domcontentloaded' });
            
            // 等待特定元素加载
            await page.waitForSelector('body');
            
            // 获取页面中的纯文本
            const pageContent = await page.evaluate(() => {
              return document.body.innerText;  // 提取纯文本内容
            });
            
            // 保存文本内容到文件
            const fs = require('fs');
            const filePath = 'response.txt';
            fs.writeFileSync(filePath, pageContent);
            console.log('Content saved to response.txt');
            
            await browser.close();
          })();
          " > puppeteer.js

      - name: Run Puppeteer script
        run: |
          # 执行 puppeteer.js 脚本
          node puppeteer.js

      - name: Create target directory
        run: |
          mkdir -p Loon/LPX

      - name: Move text content to Loon/LPX directory
        run: |
          mv response.txt "Loon/LPX/${{ secrets.FILENAME }}"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Loon/LPX/${{ secrets.FILENAME }}
          git commit -m "Add content from ${{ secrets.URL_PART }}.lpx"
          git push
